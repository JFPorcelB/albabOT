
<!doctype html>
<html lang="es">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Albito ‚Äî Chat</title>
  <style>
    :root{
      --udlba-azul:#061E3D;
      --udlba-magenta:#E0004D;
      --panel:#0b1020;
      --panel2:#0a0f1e;
      --ink:#e5e7eb;
      --muted:#cbd5e1;
      --chip:#2a2f3c;
      --line:rgba(255,255,255,.10);
      --radius:22px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      background:
        radial-gradient(900px 500px at 15% 10%, rgba(224,0,77,.16), transparent 55%),
        radial-gradient(900px 500px at 80% 15%, rgba(6,30,61,.35), transparent 60%),
        linear-gradient(180deg, #070a13 0%, #0c1732 50%, #0b1022 100%);
      color: var(--ink);
    }

    /* embed mode */
    body.embed .wrap{ max-width:100%; padding:0; }
    body.embed .shell{ border-radius: 0; box-shadow:none; border:none; }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 18px;
      height:100%;
    }
    .shell{
      height: 100%;
      display:flex;
      flex-direction:column;
      border-radius: var(--radius);
      border:1px solid rgba(255,255,255,.12);
      overflow:hidden;
      box-shadow: 0 22px 80px rgba(0,0,0,.45);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      backdrop-filter: blur(8px);
    }

    .top{
      padding: 14px 14px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.04);
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }
    .brand .avatar{
      width:56px;height:56px; /* avatar grande */
      border-radius: 50%;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      flex:0 0 auto;
      display:grid;place-items:center;
    }
    .brand .avatar img{ width:100%;height:100%; object-fit:cover; }
    .brand .txt{ min-width:0; }
    .brand h1{
      margin:0;
      font-size: 16px;
      letter-spacing:.2px;
      text-transform:none;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand p{
      margin:2px 0 0;
      font-size: 12.5px;
      color: rgba(229,231,235,.78);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .actions{
      display:flex;
      gap:10px;
      align-items:center;
      flex:0 0 auto;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size: 12px;
      padding: 7px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(229,231,235,.9);
      white-space:nowrap;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background:#f59e0b;
      box-shadow: 0 0 0 3px rgba(245,158,11,.18);
    }
    .dot.ok{ background:#22c55e; box-shadow: 0 0 0 3px rgba(34,197,94,.18); }
    .dot.bad{ background:#ef4444; box-shadow: 0 0 0 3px rgba(239,68,68,.18); }

    .btn{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(229,231,235,.95);
      border-radius: 999px;
      padding: 8px 12px;
      font-weight: 700;
      font-size: 12.5px;
    }
    .btn:hover{ background: rgba(255,255,255,.10); }

    .tipbar{
      padding: 10px 14px;
      font-size: 12.5px;
      color: rgba(229,231,235,.88);
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.03);
      display:flex;
      justify-content:space-between;
      gap:10px;
    }

    .main{
      flex: 1 1 auto;
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    .chat{
      flex: 1 1 auto;
      overflow:auto;
      padding: 14px;
      scroll-behavior:smooth;
    }

    .row{
      display:flex;
      gap:10px;
      margin: 10px 0;
      align-items:flex-end;
    }
    .row.me{ justify-content:flex-end; }
    .row.bot{ justify-content:flex-start; }

    .msgAvatar{
      width:52px;height:52px; /* avatar grande en mensajes */
      border-radius:50%;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      flex:0 0 auto;
      display:grid;place-items:center;
    }
    .msgAvatar img{ width:100%;height:100%; object-fit:cover; }

    .bubble{
      max-width: min(680px, 84%);
      border-radius: 20px;
      padding: 12px 14px;
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 14px 36px rgba(0,0,0,.22);
      line-height:1.45;
      font-size: 14px;
      position:relative;
      word-break:break-word;
      white-space:pre-wrap;
    }

    /* Albito: magenta */
    .row.bot .bubble{
      background: linear-gradient(145deg, rgba(224,0,77,.38), rgba(224,0,77,.18));
    }
    /* Usuario: azul UDALBA */
    .row.me .bubble{
      background: linear-gradient(145deg, rgba(6,30,61,.55), rgba(6,30,61,.25));
    }

    .who{
      font-weight: 800;
      font-size: 12px;
      opacity:.9;
      margin-bottom: 4px;
    }

    .controls{
      padding: 10px 14px 12px;
      border-top:1px solid var(--line);
      background: rgba(255,255,255,.03);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    .toggle{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 9px 12px;
      border-radius: 999px;
      border:1px dashed rgba(255,255,255,.16);
      background: rgba(255,255,255,.04);
      font-size: 12.5px;
      user-select:none;
    }
    .toggle input{ transform: translateY(1px); }
    .radios{
      display:flex; gap:10px; align-items:center;
      padding: 6px;
      border-radius: 999px;
      border:1px dashed rgba(255,255,255,.16);
      background: rgba(255,255,255,.04);
    }
    .radio{
      display:flex; align-items:center; gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12.5px;
      user-select:none;
    }

    .composer{
      padding: 10px 14px 14px;
      background: rgba(255,255,255,.03);
      border-top:1px solid var(--line);
      display:flex;
      gap:10px;
      align-items:center;
    }
    .input{
      flex:1 1 auto;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: rgba(229,231,235,.96);
      padding: 12px 12px;
      font-size: 14px;
      outline:none;
    }
    .send{
      flex:0 0 auto;
      border-radius: 16px;
      padding: 12px 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(224,0,77,.72);
      color:#fff;
      font-weight: 900;
      cursor:pointer;
    }
    .send:hover{ background: rgba(224,0,77,.86); }

    /* IMPORTANTE: NO chips */
    .chips, .quickChips, .suggestions { display:none !important; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="shell">
      <div class="top">
        <div class="brand">
          <div class="avatar">
            <img id="brandAvatar" src="albito.jpeg" alt="Albito" onerror="this.onerror=null;this.src='albito.jpg'">
          </div>
          <div class="txt">
            <h1>Albito  ‚Äî Chat para la Jornada Directiva</h1>
            <p>Respondo s√≥lo con los textos. Si no hay evidencia, lo dir√© (sin inventar).</p>
          </div>
        </div>

        <div class="actions">
          <div class="pill" id="kbPill"><span class="dot" id="kbDot"></span><span id="kbText">cargando KB‚Ä¶</span></div>
          <button class="btn" id="btnClear">Limpiar</button>
          <button class="btn" id="btnCopy">Copiar √∫ltima</button>
        </div>
      </div>

      <div class="tipbar">
        <div><b>Tip:</b> pregunta por <b>objetivo</b>, <b>eje</b> o <b>concepto</b>.</div>
        <div>Tip: cambia el nivel de detalle abajo.</div>
      </div>

      <div class="main">
        <div class="chat" id="chat"></div>

        <div class="controls">
          <label class="toggle"><input type="checkbox" id="tone" checked> Tono simp√°tico üê•</label>
          <label class="toggle"><input type="checkbox" id="showEvidence" checked> Mostrar evidencia</label>

          <div class="radios" role="radiogroup" aria-label="Detalle">
            <label class="radio"><input type="radio" name="detail" id="modeBrief" value="brief" checked> Breve</label>
            <label class="radio"><input type="radio" name="detail" id="modeDetail" value="detail"> En detalle</label>
          </div>
        </div>

        <div class="composer">
          <input class="input" id="q" placeholder="Escribe tu pregunta‚Ä¶ (Enter para enviar)" autocomplete="off" />
          <button class="send" id="btnSend">Enviar</button>
        </div>
      </div>
    </div>
  </div>

  <script>

    const QA_FILES = [
  { url: "./estrategia_es_QA_50_enriquecido.json",        source: "Estrategia ES" },
  { url: "./universidades_futuro_QA_50.json",             source: "Universidades del futuro" },
  { url: "./autores_vs_objetivos_QA_50_enriquecido.json", source: "Autores vs Objetivos" },
  { url: "./directrices_paises_QA_50_enriquecido.json",   source: "Directrices (pa√≠ses)" },
];
    // ---- Embed mode (para iframe) ----
    const params = new URLSearchParams(location.search);
    if(params.get("embed")==="1") document.body.classList.add("embed");

    // ---- Helpers ----
    const $ = (id) => document.getElementById(id);
    const chatEl = $("chat");

    function addMsg(who, text){
      const row = document.createElement("div");
      row.className = "row " + (who === "me" ? "me" : "bot");

      if(who === "bot"){
        const av = document.createElement("div");
        av.className = "msgAvatar";
        const img = document.createElement("img");
        img.src = "albito.jpeg";
        img.alt = "Albito";
        img.onerror = () => { img.onerror=null; img.src="albito.jpg"; };
        av.appendChild(img);
        row.appendChild(av);
      }

      const bubble = document.createElement("div");
      bubble.className = "bubble";

      const label = document.createElement("div");
      label.className = "who";
      label.textContent = (who === "me") ? "T√∫" : "Albito";
      bubble.appendChild(label);

      const body = document.createElement("div");
      body.className = "body";
      body.textContent = text;
      bubble.appendChild(body);

      row.appendChild(bubble);
      chatEl.appendChild(row);

      // autoscroll
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function setKBStatus(state, text){
      const dot = $("kbDot");
      dot.classList.remove("ok","bad");
      if(state==="ok") dot.classList.add("ok");
      if(state==="bad") dot.classList.add("bad");
      $("kbText").textContent = text;
    }

    function normalize(s){
      return (s||"")
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .replace(/[^a-z0-9\s\-\_]/g," ")
        .replace(/\s+/g," ")
        .trim();
    }

    const STOP = new Set(["de","la","el","los","las","y","o","un","una","para","por","en","a","del","al","que","con","sin","sobre","como","mas","m√°s","es","son","se","su","sus"]);
    function tokens(q){
      const t = normalize(q).split(" ").filter(Boolean).filter(w => !STOP.has(w));
      return [...new Set(t)];
    }

    // ---- KB ----
    let KB = null;
    let BLOCKS = [];

    <script>
  // === 1) Fuentes QA (solo estas 4) ===
  const QA_FILES = [
    { url: "./directrices_paises_QA_50_enriquecido.json", source: "Directrices (pa√≠ses)" },
    { url: "./universidades_futuro_QA_50.json",            source: "Debate universidades del futuro" },
    { url: "./estrategia_es_QA_50_enriquecido.json",       source: "Estrategia ES" },
    { url: "./autores_vs_objetivos_QA_50_enriquecido.json",source: "Autores vs Objetivos" }
  ];

  function asArray(x){
    if (!x) return [];
    if (Array.isArray(x)) return x;
    return [x];
  }

  function qaToBlock(qa, idx, sourceLabel, fileUrl){
    const q = (qa.question ?? qa.pregunta ?? qa.q ?? "").toString().trim();
    const a = (qa.answer   ?? qa.respuesta ?? qa.a ?? "").toString().trim();

    const variants = asArray(qa.variants ?? qa.variantes).map(v => String(v).trim()).filter(Boolean);
    const tagsRaw = qa.tags ?? qa.tag ?? qa.etiquetas;
    const tags = Array.isArray(tagsRaw) ? tagsRaw.map(String) : (tagsRaw ? String(tagsRaw).split(",") : []);
    const cleanTags = tags.map(t => t.trim()).filter(Boolean);

    const meta = {
      source: sourceLabel,
      file: fileUrl,
      doc: qa.doc ?? qa.documento ?? qa.document ?? qa.fuente ?? null,
      source_section: qa.source_section ?? qa.section ?? qa.seccion ?? null,
      timeframe: qa.timeframe ?? qa.periodo ?? null,
      country: qa.country ?? qa.pais ?? null
    };

    const parts = [];
    if (q) parts.push(`Q: ${q}`);
    if (a) parts.push(`A: ${a}`);
    if (variants.length) parts.push(`Variantes: ${variants.join(" | ")}`);
    if (cleanTags.length) parts.push(`Tags: ${cleanTags.join(", ")}`);
    const metaBits = [];
    if (meta.doc) metaBits.push(`Documento: ${meta.doc}`);
    if (meta.source_section) metaBits.push(`Secci√≥n: ${meta.source_section}`);
    if (meta.timeframe) metaBits.push(`Per√≠odo: ${meta.timeframe}`);
    if (meta.country) metaBits.push(`Pa√≠s: ${meta.country}`);
    if (metaBits.length) parts.push(metaBits.join(" ¬∑ "));

    const text = parts.join("\n");

    return {
      id: qa.id ?? `${sourceLabel}-${idx + 1}`,
      text,
      meta
    };
  }

  function normalizeAnyJsonToBlocks(json, sourceName, sourceUrl) {
  // Caso 1: ya viene como KB { blocks: [...] }
  if (json && Array.isArray(json.blocks)) {
    return json.blocks.map((b, i) => ({
      id: b.id ?? `${sourceName}-${i}`,
      text: String(b.text ?? ""),
      source: b.source ?? sourceName,
      meta: { ...(b.meta || {}), sourceUrl },
    }));
  }

  // Caso 2: Q&A como array: [{question, answer, ...}, ...]
  if (Array.isArray(json)) {
    return json.map((item, i) => {
      const q = (item.question ?? item.q ?? item.pregunta ?? "").toString().trim();
      const a = (item.answer ?? item.a ?? item.respuesta ?? "").toString().trim();

      const doc = (item.doc ?? item.document ?? item.source_doc ?? sourceName).toString().trim();
      const section = (item.source_section ?? item.section ?? item.seccion ?? "").toString().trim();
      const country = (item.country ?? item.pais ?? "").toString().trim();

      const text =
`Q: ${q}

A: ${a}

Fuente: ${doc}${section ? ` | ${section}` : ""}${country ? ` | ${country}` : ""}`.trim();

      return {
        id: `${sourceName}-qa-${i}`,
        text,
        source: sourceName,
        meta: { doc, section, country, sourceUrl },
      };
    }).filter(b => b.text.length > 0);
  }

  // Caso 3: no reconocido
  return [];
}

  // === 2) NUEVO loader: carga SOLO los 4 QA ===
  async function fetchJsonWithTimeout(url, ms = 8000) {
  const ctrl = new AbortController();
  const t = setTimeout(() => ctrl.abort(), ms);

  try {
    const res = await fetch(url, { cache: "no-store", signal: ctrl.signal });
    if (!res.ok) throw new Error(`${url} -> HTTP ${res.status}`);
    return await res.json();
  } finally {
    clearTimeout(t);
  }
}

async function loadKB() {
  setKBStatus("loading", "cargando base...");

  try {
    const settled = await Promise.allSettled(
      QA_FILES.map(async (f) => {
        const json = await fetchJsonWithTimeout(f.url, 8000);
        return { file: f, json };
      })
    );

    let blocks = [];
    for (const r of settled) {
      if (r.status !== "fulfilled") continue;
      const { file, json } = r.value;
      blocks = blocks.concat(normalizeAnyJsonToBlocks(json, file.source, file.url));
    }

    // Deduplicar por texto
    const seen = new Set();
    const uniq = [];
    for (const b of blocks) {
      const key = (b.text ?? "").trim();
      if (!key || seen.has(key)) continue;
      seen.add(key);
      uniq.push(b);
    }

    // Si no carg√≥ nada, corta y avisa (para NO quedar infinito)
    if (!uniq.length) {
      setKBStatus("bad", "KB no carg√≥");
      addMsg("bot", "No pude cargar la base. Revisa que los 4 JSON est√©n en la misma carpeta que chat.html y que sus nombres coincidan exactamente.");
      return;
    }

    KB_BLOCKS = uniq; // o el nombre de tu variable global real
    setKBStatus("ok", `KB lista ¬∑ ${uniq.length} bloques`);
  } catch (err) {
    console.error(err);
    setKBStatus("bad", "KB no carg√≥");
    addMsg("bot", `No pude cargar la base (${err?.message ?? err}).`);
  }
}

  
</script>


    function scoreBlock(b, qTokens, qNorm){
      const title = normalize(b.title);
      const text  = normalize(b.text);
      const id    = normalize(b.id);
      const tags  = Array.isArray(b.tags) ? b.tags.map(normalize) : [];

      let s = 0;

      // phrase boost
      if(qNorm && (title.includes(qNorm) || text.includes(qNorm))) s += 18;

      for(const t of qTokens){
        if(tags.includes(t)) s += 10;
        if(title.includes(t)) s += 6;
        if(id.includes(t)) s += 4;
        if(text.includes(t)) s += 2;
      }

      // prefer blocks with source/page
      if(b.source) s += 1;
      if(Number.isFinite(b.page_start)) s += 1;

      return s;
    }

    function firstSentences(raw, maxChars){
      const txt = (raw||"").replace(/\s+/g," ").trim();
      if(!txt) return "";
      // corta en ~1-2 frases sin pasarse
      const parts = txt.split(/(?<=[\.\!\?])\s+/);
      let out = "";
      for(const p of parts){
        if(!p) continue;
        if((out + " " + p).trim().length > maxChars) break;
        out = (out ? out + " " : "") + p;
        if(out.length >= Math.min(220, maxChars)) break;
      }
      if(!out) out = txt.slice(0, maxChars);
      if(out.length < txt.length) out += "‚Ä¶";
      return out;
    }

    function formatEvidence(block){
      const src = block.source ? `Fuente: ${block.source}` : "Fuente: (sin fuente)";
      const pages = (Number.isFinite(block.page_start) && Number.isFinite(block.page_end))
        ? ` (p. ${block.page_start}‚Äì${block.page_end})`
        : (Number.isFinite(block.page_start) ? ` (p. ${block.page_start})` : "");
      const title = block.title ? `\n‚Ä¢ ${block.title}` : "";
      const excerpt = firstSentences(block.text, 320);
      return `${src}${pages}${title}\n  ${excerpt}`;
    }

    function answerFromKB(q){
      if(!BLOCKS.length){
        return "A√∫n no tengo la base cargada en este modo. Pronto solucionar√© esto.";
      }

      const qNorm = normalize(q);
      const qTok = tokens(q);

      // si pregunta demasiado corta:
      if(qTok.length === 0 && qNorm.length < 3){
        return "Dime en qu√© te puedo ayudar. Por favor usa palabras clave";
      }

      const scored = BLOCKS
        .map(b => ({ b, s: scoreBlock(b, qTok, qNorm) }))
        .filter(x => x.s > 0)
        .sort((a,b)=> b.s - a.s);

      const detailMode = $("modeDetail").checked ? "detail" : "brief";
      const wantEvidence = $("showEvidence").checked;

      const take = detailMode === "detail" ? 6 : 2;
      const top = scored.slice(0, take).map(x=>x.b);

      if(top.length === 0){
        return "Lo siento, no encontr√© evidencia suficiente para responder eso. Prueba con otras palabras";
      }

      if(!wantEvidence){
        // s√≠ntesis sin citas: usa 2‚Äì4 frases ‚Äúrepresentativas‚Äù
        const bullets = top
          .map(b => firstSentences(b.text, 180))
          .filter(Boolean)
          .slice(0, detailMode === "detail" ? 4 : 2)
          .map(x => `‚Ä¢ ${x}`);
        return `S√≠ntesis (sin evidencia mostrada):\n${bullets.join("\n")}`;
      }

      const header = detailMode === "detail"
        ? `Encontr√© evidencia  (top ${top.length}):`
        : `Encontr√© evidencia:`;

      return `${header}\n\n` + top.map(formatEvidence).join("\n\n");
    }

    // ---- UI actions ----
    function send(){
      const q = $("q").value.trim();
      if(!q) return;

      addMsg("me", q);
      $("q").value = "";

      const tone = $("tone").checked;
      const prefix = tone ? "P√≠o p√≠o üê•. " : "";

      const resp = answerFromKB(q);
      addMsg("bot", prefix + resp);
    }

    $("btnSend").addEventListener("click", send);
    $("q").addEventListener("keydown", (e)=>{
      if(e.key==="Enter"){
        e.preventDefault();
        send();
      }
    });

    $("btnClear").addEventListener("click", ()=>{
      chatEl.innerHTML = "";
      greeting();
    });

    $("btnCopy").addEventListener("click", async ()=>{
      const bubbles = [...document.querySelectorAll(".row.bot .bubble .body")];
      if(!bubbles.length) return;
      const last = bubbles[bubbles.length-1].textContent || "";
      try{ await navigator.clipboard.writeText(last.trim()); }catch(e){}
    });

    function greeting(){
      addMsg("bot", "Hola, soy Albito üê¶ y te ayudar√© en esta jornada con la informaci√≥n dada por la Direcci√≥n General de Desarrollo Institucional");
    }

    // Init
    greeting();
    loadKB().then(ok=>{
      if(!ok){
        addMsg("bot","No pude cargar la KB. Aseg√∫rate de que kb_udl.json est√© en la misma carpeta que este chat (en GitHub Pages debe quedar en la ra√≠z del repo).");
      }
    });
  </script>
</body>
</html>







