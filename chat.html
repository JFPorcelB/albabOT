<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Albito ‚Äî Chat</title>
  <style>
    :root{
      --udlba-azul:#061E3D;
      --udlba-magenta:#E0004D;
      --panel:#0b1020;
      --panel2:#0a0f1e;
      --ink:#e5e7eb;
      --muted:#cbd5e1;
      --chip:#2a2f3c;
      --line:rgba(255,255,255,.10);
      --radius:22px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      background:
        radial-gradient(900px 500px at 15% 10%, rgba(224,0,77,.16), transparent 55%),
        radial-gradient(900px 500px at 80% 15%, rgba(6,30,61,.35), transparent 60%),
        linear-gradient(180deg, #070a13 0%, #0c1732 50%, #0b1022 100%);
      color: var(--ink);
    }

    /* embed mode */
    body.embed .wrap{ max-width:100%; padding:0; }
    body.embed .shell{ border-radius: 0; box-shadow:none; border:none; }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 18px;
      height:100%;
    }
    .shell{
      height: 100%;
      display:flex;
      flex-direction:column;
      border-radius: var(--radius);
      border:1px solid rgba(255,255,255,.12);
      overflow:hidden;
      box-shadow: 0 22px 80px rgba(0,0,0,.45);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      backdrop-filter: blur(8px);
    }

    .top{
      padding: 14px 14px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.04);
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }
    .brand .avatar{
      width:56px;height:56px;
      border-radius: 50%;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      flex:0 0 auto;
      display:grid;place-items:center;
    }
    .brand .avatar img{ width:100%;height:100%; object-fit:cover; }
    .brand .txt{ min-width:0; }
    .brand h1{
      margin:0;
      font-size: 16px;
      letter-spacing:.2px;
      text-transform:none;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand p{
      margin:2px 0 0;
      font-size: 12.5px;
      color: rgba(229,231,235,.78);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .actions{
      display:flex;
      gap:10px;
      align-items:center;
      flex:0 0 auto;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size: 12px;
      padding: 7px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(229,231,235,.9);
      white-space:nowrap;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background:#f59e0b;
      box-shadow: 0 0 0 3px rgba(245,158,11,.18);
    }
    .dot.ok{ background:#22c55e; box-shadow: 0 0 0 3px rgba(34,197,94,.18); }
    .dot.bad{ background:#ef4444; box-shadow: 0 0 0 3px rgba(239,68,68,.18); }

    .btn{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(229,231,235,.95);
      border-radius: 999px;
      padding: 8px 12px;
      font-weight: 700;
      font-size: 12.5px;
    }
    .btn:hover{ background: rgba(255,255,255,.10); }

    .tipbar{
      padding: 10px 14px;
      font-size: 12.5px;
      color: rgba(229,231,235,.88);
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.03);
      display:flex;
      justify-content:space-between;
      gap:10px;
    }

    .main{
      flex: 1 1 auto;
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    .chat{
      flex: 1 1 auto;
      overflow:auto;
      padding: 14px;
      scroll-behavior:smooth;
    }

    .row{
      display:flex;
      gap:10px;
      margin: 10px 0;
      align-items:flex-end;
    }
    .row.me{ justify-content:flex-end; }
    .row.bot{ justify-content:flex-start; }

    .msgAvatar{
      width:52px;height:52px;
      border-radius:50%;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      flex:0 0 auto;
      display:grid;place-items:center;
    }
    .msgAvatar img{ width:100%;height:100%; object-fit:cover; }

    .bubble{
      max-width: min(680px, 84%);
      border-radius: 20px;
      padding: 12px 14px;
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 14px 36px rgba(0,0,0,.22);
      line-height:1.45;
      font-size: 14px;
      position:relative;
      word-break:break-word;
      white-space:pre-wrap;
    }

    .row.bot .bubble{
      background: linear-gradient(145deg, rgba(224,0,77,.38), rgba(224,0,77,.18));
    }
    .row.me .bubble{
      background: linear-gradient(145deg, rgba(6,30,61,.55), rgba(6,30,61,.25));
    }

    .who{
      font-weight: 800;
      font-size: 12px;
      opacity:.9;
      margin-bottom: 4px;
    }

    .controls{
      padding: 10px 14px 12px;
      border-top:1px solid var(--line);
      background: rgba(255,255,255,.03);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    .toggle{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 9px 12px;
      border-radius: 999px;
      border:1px dashed rgba(255,255,255,.16);
      background: rgba(255,255,255,.04);
      font-size: 12.5px;
      user-select:none;
    }
    .toggle input{ transform: translateY(1px); }
    .radios{
      display:flex; gap:10px; align-items:center;
      padding: 6px;
      border-radius: 999px;
      border:1px dashed rgba(255,255,255,.16);
      background: rgba(255,255,255,.04);
    }
    .radio{
      display:flex; align-items:center; gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12.5px;
      user-select:none;
    }

    .composer{
      padding: 10px 14px 14px;
      background: rgba(255,255,255,.03);
      border-top:1px solid var(--line);
      display:flex;
      gap:10px;
      align-items:center;
    }
    .input{
      flex:1 1 auto;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: rgba(229,231,235,.96);
      padding: 12px 12px;
      font-size: 14px;
      outline:none;
    }
    .send{
      flex:0 0 auto;
      border-radius: 16px;
      padding: 12px 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(224,0,77,.72);
      color:#fff;
      font-weight: 900;
      cursor:pointer;
    }
    .send:hover{ background: rgba(224,0,77,.86); }

    /* NO chips */
    .chips, .quickChips, .suggestions { display:none !important; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="shell">
      <div class="top">
        <div class="brand">
          <div class="avatar">
            <img id="brandAvatar" src="albito.jpeg" alt="Albito" onerror="this.onerror=null;this.src='albito.jpg'">
          </div>
          <div class="txt">
            <h1>Albito ‚Äî Chat para la Jornada Directiva</h1>
            <p>Respondo solo con los textos. Si no hay evidencia, lo dir√© (sin inventar).</p>
          </div>
        </div>

        <div class="actions">
          <div class="pill" id="kbPill"><span class="dot" id="kbDot"></span><span id="kbText">cargando base‚Ä¶</span></div>
          <button class="btn" id="btnClear">Limpiar</button>
          <button class="btn" id="btnCopy">Copiar √∫ltima</button>
        </div>
      </div>

      <div class="tipbar">
        <div><b>Tip:</b> pregunta por <b>pa√≠s</b>, <b>eje</b>, <b>concepto</b> o <b>objetivo</b>.</div>
        <div>Tip: cambia el nivel de detalle abajo.</div>
      </div>

      <div class="main">
        <div class="chat" id="chat"></div>

        <div class="controls">
          <label class="toggle"><input type="checkbox" id="tone" checked> Tono simp√°tico üê•</label>
          <label class="toggle"><input type="checkbox" id="showEvidence" checked> Mostrar evidencia</label>

          <div class="radios" role="radiogroup" aria-label="Detalle">
            <label class="radio"><input type="radio" name="detail" id="modeBrief" value="brief" checked> Breve</label>
            <label class="radio"><input type="radio" name="detail" id="modeDetail" value="detail"> En detalle</label>
          </div>
        </div>

        <div class="composer">
          <input class="input" id="q" placeholder="Escribe tu pregunta‚Ä¶ (Enter para enviar)" autocomplete="off" />
          <button class="send" id="btnSend">Enviar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // 1) SOLO estas 4 fuentes QA
    // =========================
    const QA_FILES = [
      { url: "./estrategia_es_QA_50_enriquecido.json",        source: "Estrategia ES" },
      { url: "./universidades_futuro_QA_50.json",             source: "Universidades del futuro" },
      { url: "./autores_vs_objetivos_QA_50_enriquecido.json", source: "Autores vs Objetivos" },
      { url: "./directrices_paises_QA_50_enriquecido.json",   source: "Directrices (pa√≠ses)" },
    ];

    // ---- Embed mode (iframe) ----
    const params = new URLSearchParams(location.search);
    if(params.get("embed")==="1") document.body.classList.add("embed");

    // ---- DOM helpers ----
    const $ = (id) => document.getElementById(id);
    const chatEl = $("chat");

    // ---- Estado KB ----
    let BLOCKS = [];

    function setKBStatus(state, text){
      const dot = $("kbDot");
      dot.classList.remove("ok","bad");
      if(state==="ok") dot.classList.add("ok");
      if(state==="bad") dot.classList.add("bad");
      $("kbText").textContent = text;
    }

    // ---- UI messages ----
    function addMsg(who, text){
      const row = document.createElement("div");
      row.className = "row " + (who === "me" ? "me" : "bot");

      if(who === "bot"){
        const av = document.createElement("div");
        av.className = "msgAvatar";
        const img = document.createElement("img");
        img.src = "albito.jpeg";
        img.alt = "Albito";
        img.onerror = () => { img.onerror=null; img.src="albito.jpg"; };
        av.appendChild(img);
        row.appendChild(av);
      }

      const bubble = document.createElement("div");
      bubble.className = "bubble";

      const label = document.createElement("div");
      label.className = "who";
      label.textContent = (who === "me") ? "T√∫" : "Albito";
      bubble.appendChild(label);

      const body = document.createElement("div");
      body.className = "body";
      body.textContent = text;
      bubble.appendChild(body);

      row.appendChild(bubble);
      chatEl.appendChild(row);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    // ---- Text utils ----
    function normalize(s){
      return (s||"")
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .replace(/[^a-z0-9\s\-\_]/g," ")
        .replace(/\s+/g," ")
        .trim();
    }

    const STOP = new Set(["de","la","el","los","las","y","o","un","una","para","por","en","a","del","al","que","con","sin","sobre","como","mas","m√°s","es","son","se","su","sus"]);
    function tokens(q){
      const t = normalize(q).split(" ").filter(Boolean).filter(w => !STOP.has(w));
      return [...new Set(t)];
    }

    // ---- Fetch con timeout (para no quedar ‚Äúcargando‚Äù infinito) ----
    async function fetchJsonWithTimeout(url, ms=9000){
      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort(), ms);
      try{
        // cache:no-store + query bust para GitHub Pages
        const bust = (url.includes("?") ? "&" : "?") + "v=" + Date.now();
        const res = await fetch(url + bust, { cache:"no-store", signal: ctrl.signal });
        if(!res.ok) throw new Error(`${url} -> HTTP ${res.status}`);
        return await res.json();
      } finally {
        clearTimeout(t);
      }
    }

    // ---- Normaliza tus QA a bloques ----
    function asArray(x){
      if(!x) return [];
      return Array.isArray(x) ? x : [x];
    }

    function normalizeAnyJsonToBlocks(json, sourceName, sourceUrl){
      // Si viene como { blocks: [...] }
      if(json && Array.isArray(json.blocks)){
        return json.blocks.map((b,i)=>({
          id: b.id ?? `${sourceName}-kb-${i}`,
          title: String(b.title ?? b.question ?? ""),
          text: String(b.text ?? b.answer ?? ""),
          tags: Array.isArray(b.tags) ? b.tags.map(String) : [],
          source: b.source ?? sourceName,
          meta: { ...(b.meta||{}), sourceUrl }
        })).filter(b => (b.title || b.text));
      }

      // Si viene como array de QAs
      if(Array.isArray(json)){
        return json.map((qa,i)=>{
          const q = String(qa.question ?? qa.pregunta ?? qa.q ?? "").trim();
          const a = String(qa.answer ?? qa.respuesta ?? qa.a ?? "").trim();
          const vars = asArray(qa.variants ?? qa.variantes).map(v=>String(v).trim()).filter(Boolean);
          const tagsRaw = qa.tags ?? qa.tag ?? qa.etiquetas ?? [];
          const tags = Array.isArray(tagsRaw) ? tagsRaw.map(String) : String(tagsRaw).split(",").map(s=>s.trim()).filter(Boolean);

          const meta = {
            doc: qa.doc ?? qa.documento ?? qa.document ?? qa.fuente ?? null,
            source_section: qa.source_section ?? qa.section ?? qa.seccion ?? null,
            timeframe: qa.timeframe ?? qa.periodo ?? null,
            country: qa.country ?? qa.pais ?? null,
            file: sourceUrl
          };

          return {
            id: qa.id ?? `${sourceName}-qa-${i+1}`,
            title: q,
            text: a,
            tags,
            source: sourceName,
            meta
          };
        }).filter(b => (b.title || b.text));
      }

      return [];
    }

    // ---- Carga la base desde los 4 archivos ----
    async function loadKB(){
      setKBStatus("loading","cargando base‚Ä¶");

      const settled = await Promise.allSettled(
        QA_FILES.map(async (f) => {
          const json = await fetchJsonWithTimeout(f.url, 9000);
          return { file: f, json };
        })
      );

      let blocks = [];
      let okFiles = 0;

      for(const r of settled){
        if(r.status !== "fulfilled") continue;
        okFiles++;
        const { file, json } = r.value;
        blocks = blocks.concat(normalizeAnyJsonToBlocks(json, file.source, file.url));
      }

      // Dedup por title+text
      const seen = new Set();
      const uniq = [];
      for(const b of blocks){
        const key = (b.title + "\n" + b.text).trim();
        if(!key || seen.has(key)) continue;
        seen.add(key);
        uniq.push(b);
      }

      BLOCKS = uniq;

      if(!BLOCKS.length){
        setKBStatus("bad","KB no carg√≥");
        return false;
      }

      setKBStatus("ok", `KB lista ¬∑ ${BLOCKS.length} bloques ¬∑ ${okFiles}/${QA_FILES.length} archivos`);
      return true;
    }

    // ---- Ranking + respuesta ----
    function scoreBlock(b, qTokens, qNorm){
      const title = normalize(b.title);
      const text  = normalize(b.text);
      const id    = normalize(b.id);
      const tags  = Array.isArray(b.tags) ? b.tags.map(normalize) : [];

      let s = 0;

      if(qNorm && (title.includes(qNorm) || text.includes(qNorm))) s += 18;

      for(const t of qTokens){
        if(tags.includes(t)) s += 10;
        if(title.includes(t)) s += 7;
        if(text.includes(t)) s += 3;
        if(id.includes(t)) s += 2;
      }

      // bonus si tiene metadata √∫til
      if(b.meta?.doc) s += 2;
      if(b.meta?.source_section) s += 1;
      if(b.meta?.country) s += 1;

      return s;
    }

    function clipText(raw, maxChars){
      const txt = (raw||"").replace(/\s+/g," ").trim();
      if(txt.length <= maxChars) return txt;
      return txt.slice(0, maxChars).trim() + "‚Ä¶";
    }

    function formatEvidence(block, mode){
      const doc = block.meta?.doc ? String(block.meta.doc) : block.source;
      const sec = block.meta?.source_section ? ` ¬∑ ${block.meta.source_section}` : "";
      const country = block.meta?.country ? ` ¬∑ ${block.meta.country}` : "";
      const time = block.meta?.timeframe ? ` ¬∑ ${block.meta.timeframe}` : "";

      const answer = (mode === "detail") ? clipText(block.text, 1200) : clipText(block.text, 420);

      return `Fuente: ${doc}${sec}${country}${time}\n‚Ä¢ ${answer}`;
    }

    function answerFromKB(q){
      if(!BLOCKS.length){
        return "A√∫n no tengo la base cargada. Revisa que los 4 JSON est√©n en la misma carpeta que chat.html (GitHub Pages) y que los nombres coincidan exacto.";
      }

      const qNorm = normalize(q);
      const qTok = tokens(q);

      if(qTok.length === 0 && qNorm.length < 3){
        return "Dime en qu√© te puedo ayudar. Usa 2‚Äì3 palabras clave (pa√≠s + tema, eje, o concepto).";
      }

      const scored = BLOCKS
        .map(b => ({ b, s: scoreBlock(b, qTok, qNorm) }))
        .filter(x => x.s > 0)
        .sort((a,b)=> b.s - a.s);

      if(!scored.length){
        return "No encontr√© evidencia suficiente con esas palabras. Prueba reformulando (pa√≠s + tema) o usando otro concepto clave.";
      }

      const modeDetailEl = $("modeDetail");
const showEvidenceEl = $("showEvidence");

const detailMode = (modeDetailEl && modeDetailEl.checked) ? "detail" : "brief";
const wantEvidence = showEvidenceEl ? showEvidenceEl.checked : true;


      const take = (detailMode === "detail") ? 4 : 2;
      const top = scored.slice(0, take).map(x=>x.b);

      if(!wantEvidence){
        // respuesta ‚Äúlimpia‚Äù: usa el mejor bloque como base
        const main = top[0];
        const extra = (detailMode === "detail" && top[1]) ? ("\n\n(Complemento)\n" + clipText(top[1].text, 420)) : "";
        return clipText(main.text, detailMode === "detail" ? 1200 : 520) + extra;
      }

      const header = (detailMode === "detail")
        ? `Encontr√© evidencia (top ${top.length}):`
        : `Encontr√© evidencia:`;

      return `${header}\n\n` + top.map(b => formatEvidence(b, detailMode)).join("\n\n");
    }

    // ---- UI actions ----
    function send(){
  const qEl = $("q");
  const q = (qEl ? qEl.value : "").trim();
  if(!q) return;

  addMsg("me", q);
  if(qEl) qEl.value = "";

  // ‚úÖ si los toggles no existen, usa defaults
  const toneEl = $("tone");
  const tone = toneEl ? toneEl.checked : true;
  const prefix = tone ? "P√≠o p√≠o üê•. " : "";

  try{
    const resp = answerFromKB(q);
    addMsg("bot", prefix + resp);
  }catch(err){
    console.error(err);
    addMsg("bot", "Ups‚Ä¶ hubo un error interno al responder. Revisa la consola (F12 ‚Üí Console).");
  }
}


    $("btnSend").addEventListener("click", send);
    $("q").addEventListener("keydown", (e)=>{
      if(e.key==="Enter"){
        e.preventDefault();
        send();
      }
    });

    $("btnClear").addEventListener("click", ()=>{
      chatEl.innerHTML = "";
      greeting();
    });

    $("btnCopy").addEventListener("click", async ()=>{
      const bubbles = [...document.querySelectorAll(".row.bot .bubble .body")];
      if(!bubbles.length) return;
      const last = bubbles[bubbles.length-1].textContent || "";
      try{ await navigator.clipboard.writeText(last.trim()); }catch(e){}
    });

    function greeting(){
      addMsg("bot", "Hola, soy Albito üê¶ y te ayudar√© en esta jornada con la informaci√≥n dada por la Direcci√≥n General de Desarrollo Institucional.");
    }

    // ---- Init ----
    (async ()=>{
      greeting();
      const ok = await loadKB();
      if(!ok){
        addMsg("bot","No pude cargar la base. Lo arreglar√© en breve");
      }
    })();
  </script>
</body>
</html>
