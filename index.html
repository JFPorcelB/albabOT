<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Albito ‚Äî Chat Jornada Directiva</title>
  <style>
    :root{
      --udl-blue:#061E3D;
      --udl-magenta:#E0004D;
      --ink:#0b1220;
      --muted:#6b7280;
      --panel:#ffffff;
      --line:rgba(15,23,42,.12);
      --shadow:0 10px 30px rgba(2,6,23,.12);
      --radius:18px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(224,0,77,.14), transparent 60%),
        radial-gradient(1000px 650px at 80% 0%, rgba(6,30,61,.18), transparent 60%),
        linear-gradient(180deg, #0a1a33 0%, #0b1220 100%);
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:18px;
    }

    .wrap{
      width:min(980px, 100%);
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      border-radius:26px;
      box-shadow:var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }

    /* Top bar (solo modo standalone) */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:14px 14px;
      background:rgba(255,255,255,.12);
      border-bottom:1px solid rgba(255,255,255,.12);
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
    }
    .brand .avatar{
      width:44px;height:44px;border-radius:14px;
      background:rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.18);
      display:grid;place-items:center;
      overflow:hidden;
      flex:0 0 auto;
    }
    .brand .avatar img{width:100%;height:100%;object-fit:cover}
    .brand .t{min-width:0}
    .brand .t .h{
      font-weight:800;
      color:#fff;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand .t .s{
      margin-top:2px;
      font-size:12.5px;
      color:rgba(255,255,255,.75);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.10);
      color:#fff;
      font-size:12.5px;
      user-select:none;
    }
    .dot{width:10px;height:10px;border-radius:999px;background:#fbbf24;box-shadow:0 0 0 4px rgba(251,191,36,.15)}
    .dot.ok{background:#22c55e;box-shadow:0 0 0 4px rgba(34,197,94,.15)}
    .dot.bad{background:#ef4444;box-shadow:0 0 0 4px rgba(239,68,68,.15)}

    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.10);
      color:#fff;
      padding:8px 12px;
      border-radius:14px;
      font-weight:700;
      cursor:pointer;
      transition:transform .05s ease, background .15s ease, border-color .15s ease;
    }
    .btn:hover{background:rgba(255,255,255,.14);border-color:rgba(255,255,255,.24)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{
      background:rgba(224,0,77,.16);
      border-color:rgba(224,0,77,.35);
    }
    .btn.primary:hover{background:rgba(224,0,77,.22)}

    /* Chat panel */
    .panel{
      display:flex;
      flex-direction:column;
      height:min(82vh, 760px);
      background:rgba(255,255,255,.10);
    }

    .hintbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:10px 14px;
      background:rgba(255,255,255,.12);
      border-bottom:1px solid rgba(255,255,255,.12);
      color:rgba(255,255,255,.92);
      font-size:13px;
    }
    .hintbar b{color:#fff}
    .hintbar .right{color:rgba(255,255,255,.80)}

    .chat{
      flex:1 1 auto;
      overflow:auto;
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:12px;
      scroll-behavior:smooth;
      background:
        radial-gradient(900px 500px at 20% 0%, rgba(224,0,77,.20), transparent 60%),
        radial-gradient(900px 500px at 80% 0%, rgba(6,30,61,.25), transparent 60%),
        linear-gradient(180deg, rgba(10,26,51,.70), rgba(11,18,32,.65));
    }

    .row{
      display:flex;
      gap:10px;
      align-items:flex-end;
    }
    .row.user{justify-content:flex-end}
    .row.bot{justify-content:flex-start}

    .who{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      width:72px; /* avatar m√°s grande */
      flex:0 0 72px;
    }
    .who .pic{
      width:60px;height:60px;border-radius:999px;
      border:2px solid rgba(255,255,255,.85);
      box-shadow:0 8px 20px rgba(0,0,0,.25);
      overflow:hidden;
      background:#fff;
    }
    .who .pic img{width:100%;height:100%;object-fit:cover}
    .who .name{
      font-size:12px;
      color:rgba(255,255,255,.80);
      font-weight:700;
    }

    .bubble{
      max-width:min(720px, 78%);
      border-radius:22px;
      padding:14px 16px;
      line-height:1.35;
      box-shadow:0 12px 26px rgba(0,0,0,.20);
      border:1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(8px);
      position:relative;
      white-space:pre-wrap;
      word-wrap:break-word;
    }
    .bubble.bot{
      background:rgba(224,0,77,.22);
      color:#fff;
    }
    .bubble.user{
      background:rgba(6,30,61,.30);
      color:#fff;
      border-color:rgba(255,255,255,.16);
    }
    .bubble .meta{
      display:block;
      font-size:12px;
      font-weight:800;
      opacity:.85;
      margin-bottom:6px;
    }
    .bubble.bot:before{
      content:"";
      position:absolute; left:-8px; bottom:18px;
      width:14px;height:14px;
      background:rgba(224,0,77,.22);
      border-left:1px solid rgba(255,255,255,.14);
      border-bottom:1px solid rgba(255,255,255,.14);
      transform:rotate(45deg);
      border-bottom-left-radius:4px;
    }
    .bubble.user:before{
      content:"";
      position:absolute; right:-8px; bottom:18px;
      width:14px;height:14px;
      background:rgba(6,30,61,.30);
      border-right:1px solid rgba(255,255,255,.16);
      border-bottom:1px solid rgba(255,255,255,.16);
      transform:rotate(45deg);
      border-bottom-right-radius:4px;
    }

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      padding:10px 14px 0;
      background:rgba(255,255,255,.10);
      border-top:1px solid rgba(255,255,255,.12);
    }
    .chip{
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.10);
      color:#fff;
      padding:8px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
      transition:background .15s ease, transform .05s ease, border-color .15s ease;
      white-space:nowrap;
    }
    .chip:hover{background:rgba(255,255,255,.14);border-color:rgba(255,255,255,.24)}
    .chip:active{transform:translateY(1px)}

    .controls{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:10px 14px;
      background:rgba(255,255,255,.10);
      border-top:1px solid rgba(255,255,255,.12);
      flex-wrap:wrap;
    }

    .toggle{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border:1px dashed rgba(255,255,255,.22);
      border-radius:16px;
      color:#fff;
      background:rgba(255,255,255,.08);
      user-select:none;
      font-weight:700;
      font-size:13px;
    }
    .toggle input{width:18px;height:18px; accent-color: var(--udl-magenta);}
    .seg{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border:1px dashed rgba(255,255,255,.22);
      border-radius:16px;
      color:#fff;
      background:rgba(255,255,255,.08);
      user-select:none;
      font-weight:800;
      font-size:13px;
    }
    .seg label{display:inline-flex;align-items:center;gap:8px;cursor:pointer}
    .seg input{accent-color: var(--udl-magenta); width:16px;height:16px}

    .composer{
      display:flex;
      gap:10px;
      padding:12px 14px;
      background:rgba(255,255,255,.10);
      border-top:1px solid rgba(255,255,255,.12);
      align-items:flex-end;
    }
    .composer textarea{
      flex:1 1 auto;
      resize:none;
      min-height:44px;
      max-height:110px;
      padding:12px 14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.18);
      color:#fff;
      outline:none;
      font-size:15px;
      line-height:1.25;
    }
    .composer textarea::placeholder{color:rgba(255,255,255,.60)}
    .send{
      flex:0 0 auto;
      padding:12px 16px;
      border-radius:18px;
      border:1px solid rgba(224,0,77,.40);
      background:rgba(224,0,77,.18);
      color:#fff;
      font-weight:900;
      cursor:pointer;
      transition:transform .05s ease, background .15s ease, border-color .15s ease;
    }
    .send:hover{background:rgba(224,0,77,.26);border-color:rgba(224,0,77,.55)}
    .send:active{transform:translateY(1px)}

    /* Embed mode: compacto, sin topbar, sin bordes extra */
    body.embed{padding:0; background:transparent; display:block}
    body.embed .wrap{border:none; border-radius:0; box-shadow:none; background:transparent}
    body.embed .topbar{display:none !important}
    body.embed .panel{height:100vh}
    body.embed .hintbar{border-radius:0}
    body.embed .chips, body.embed .controls, body.embed .composer{border-radius:0}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar" id="topbar">
      <div class="brand">
        <div class="avatar"><img src="./albito.jpeg" alt="Albito"></div>
        <div class="t">
          <div class="h">Albito (demo) ‚Äî Chat para la Jornada Directiva</div>
          <div class="s">Responde solo con kb_udl.json. Si no hay evidencia, lo dir√© (sin inventar).</div>
        </div>
      </div>
      <div class="actions">
        <div class="pill" id="kbPill"><span class="dot" id="kbDot"></span><span id="kbText">cargando KB‚Ä¶</span></div>
        <button class="btn" id="btnClear" type="button">Limpiar</button>
        <button class="btn primary" id="btnCopyLast" type="button">Copiar √∫ltima</button>
      </div>
    </div>

    <div class="panel">
      <div class="hintbar">
        <div>Haz preguntas espec√≠ficas (pa√≠s + tema). Ej: <b>‚ÄúReino Unido + IA + evaluaci√≥n‚Äù</b> o <b>‚Äúgobernanza anticipatoria‚Äù</b>.</div>
        <div class="right">Tip: cambia el nivel de detalle abajo.</div>
      </div>

      <div class="chat" id="chat"></div>

      <div class="chips" id="chips"></div>

      <div class="controls">
        <div class="toggle"><input id="toneNice" type="checkbox" checked> Tono simp√°tico üê§</div>
        <div class="toggle"><input id="showEvidence" type="checkbox" checked> Mostrar evidencia</div>
        <div class="seg" role="group" aria-label="Nivel de detalle">
          <label><input type="radio" name="detail" value="detail" checked> En detalle</label>
          <label><input type="radio" name="detail" value="brief"> Breve</label>
        </div>
      </div>

      <div class="composer">
        <textarea id="q" placeholder="Escribe tu pregunta‚Ä¶ (Enter para enviar)"></textarea>
        <button class="send" id="btnSend" type="button">Enviar</button>
      </div>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  // ---- embed mode ----
  const params = new URLSearchParams(location.search);
  const isEmbed = params.get("embed") === "1";
  if (isEmbed) document.body.classList.add("embed");

  // ---- UI ----
  const chatEl = $("chat");
  const chipsEl = $("chips");
  const kbDot = $("kbDot");
  const kbText = $("kbText");
  const kbPill = $("kbPill");
  const btnClear = $("btnClear");
  const btnSend = $("btnSend");
  const btnCopyLast = $("btnCopyLast");
  const q = $("q");
  const toneNice = $("toneNice");
  const showEvidence = $("showEvidence");

  // En embed, igual dejamos los botones dentro del chat (pero topbar se oculta).
  // Si quieres botones tambi√©n en embed, puedes duplicarlos en demo, pero por ahora no.

  // ---- state ----
  let KB = null;
  let KB_LOADED_FROM = null;

  const DEFAULT_CHIPS = [
    "Reino Unido + IA + evaluaci√≥n",
    "gobernanza anticipatoria",
    "microcredenciales apilables",
    "Desaf√≠o 3 Estrategia ES",
    "Pa√≠ses Bajos + interoperabilidad",
    "Singapur + rutas flexibles"
  ];

  function setKbStatus(state, text){
    kbText.textContent = text;
    kbDot.classList.remove("ok","bad");
    if(state === "ok") kbDot.classList.add("ok");
    if(state === "bad") kbDot.classList.add("bad");
  }

  function escapeHtml(s){
    return s.replace(/[&<>"']/g, (c)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  function addMsg(role, text){
    const row = document.createElement("div");
    row.className = "row " + (role === "user" ? "user" : "bot");

    if(role === "bot"){
      const who = document.createElement("div");
      who.className = "who";
      who.innerHTML = `
        <div class="pic"><img src="./albito.jpeg" alt="Albito"></div>
        <div class="name">Albito</div>
      `;
      const bubble = document.createElement("div");
      bubble.className = "bubble bot";
      bubble.innerHTML = `<span class="meta">Albito</span>${escapeHtml(text)}`;
      row.appendChild(who);
      row.appendChild(bubble);
    } else {
      const bubble = document.createElement("div");
      bubble.className = "bubble user";
      bubble.innerHTML = `<span class="meta">T√∫</span>${escapeHtml(text)}`;
      row.appendChild(bubble);
    }

    chatEl.appendChild(row);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function setChips(list){
    chipsEl.innerHTML = "";
    list.forEach(t => {
      const b = document.createElement("button");
      b.className = "chip";
      b.type = "button";
      b.textContent = t;
      b.addEventListener("click", () => {
        q.value = t;
        send();
      });
      chipsEl.appendChild(b);
    });
  }

  function greeting(){
    chatEl.innerHTML = "";
    const msg =
`Hola, soy Albito üê§.
Puedo ayudarte a encontrar ideas espec√≠ficas para la Jornada Directiva usando los documentos entregados por la Direcci√≥n de Desarrollo Institucional.

Cu√©ntame un pa√≠s, un eje o un concepto y te respondo con evidencia.`;
    addMsg("bot", msg);
  }

  // ---- KB loading (robusto en embed + GitHub Pages) ----
  async function loadKB(){
    setKbStatus("loading", "cargando KB‚Ä¶");

    // Usamos URL relativa a ESTE index.html (sirve en /repo/ y en iframe).
    const base = new URL(".", location.href);
    const candidates = [
      new URL("kb_udl.json", base).toString(),
      "./kb_udl.json",
      "../kb_udl.json"
    ];

    for(const url of candidates){
      try{
        const r = await fetch(url, { cache: "no-store" });
        if(!r.ok) continue;
        const data = await r.json();
        if(!data || !Array.isArray(data.blocks)) continue;

        // Pre-index simple
        data._indexed = data.blocks.map(b => {
          const title = (b.title || "").toString();
          const tags  = Array.isArray(b.tags) ? b.tags.join(" ") : "";
          const text  = (b.text || "").toString();
          const hay   = (title + " " + tags + " " + text).toLowerCase();
          return { b, hay };
        });

        KB = data;
        KB_LOADED_FROM = url;

        setKbStatus("ok", `KB lista ¬∑ ${data.blocks.length} bloques`);
        return true;
      } catch(e){
        // sigue intentando
      }
    }

    KB = null;
    KB_LOADED_FROM = candidates[0];
    setKbStatus("bad", "no pude cargar KB");
    addMsg("bot", `No pude cargar la base (kb_udl.json).\nEstoy intentando desde: ${candidates.join(" | ")}`);
    return false;
  }

  // ---- Retrieval / respuesta (sin inventar) ----
  function normalizeWords(s){
    return (s || "")
      .toLowerCase()
      .replace(/[^\p{L}\p{N}\s+]/gu, " ")
      .replace(/\s+/g, " ")
      .trim()
      .split(" ")
      .filter(w => w.length >= 3);
  }

  function scoreBlock(hay, words){
    let score = 0;
    for(const w of words){
      if(hay.includes(w)) score += 1;
    }
    // bonus por consultas t√≠picas con '+'
    if(words.includes("ia") && hay.includes("ia")) score += 1;
    return score;
  }

  function pickSentences(text, words, maxSentences){
    const raw = (text || "").replace(/\s+/g, " ").trim();
    if(!raw) return [];

    const parts = raw.split(/(?<=[\.\!\?])\s+/);
    const hits = [];
    for(const p of parts){
      const lc = p.toLowerCase();
      let c = 0;
      for(const w of words){
        if(lc.includes(w)) c++;
      }
      if(c > 0) hits.push({ p: p.trim(), c });
    }
    hits.sort((a,b)=>b.c-a.c);
    return hits.slice(0, maxSentences).map(x => x.p);
  }

  function formatSource(b){
    const src = b.source ? `Fuente: ${b.source}` : "Fuente: (sin fuente)";
    const pg = (Number.isFinite(b.page_start) && Number.isFinite(b.page_end))
      ? ` (p. ${b.page_start}‚Äì${b.page_end})`
      : (Number.isFinite(b.page_start) ? ` (p. ${b.page_start})` : "");
    return src + pg;
  }

  function answerFromKB(query){
    if(!KB || !KB._indexed){
      return {
        ok:false,
        text: "A√∫n no tengo la base lista en este modo. Si est√°s viendo esto dentro de una p√°gina, normalmente es porque la KB se est√° buscando en otra ruta.\n\nTip t√©cnico: el chat est√° intentando cargar: kb_udl.json"
      };
    }

    const words = normalizeWords(query);
    if(words.length === 0){
      return { ok:false, text: "¬øMe das un poquito m√°s de precisi√≥n? Por ejemplo: pa√≠s + tema (ej. ‚ÄúReino Unido + IA + evaluaci√≥n‚Äù)." };
    }

    const scored = KB._indexed
      .map(({b, hay}) => ({ b, s: scoreBlock(hay, words) }))
      .filter(x => x.s > 0)
      .sort((a,b)=>b.s-a.s);

    const mode = document.querySelector('input[name="detail"]:checked')?.value || "detail";
    const wantEvidence = showEvidence.checked;
    const nice = toneNice.checked;

    const topN = (mode === "brief") ? 3 : 6;
    const hits = scored.slice(0, topN);

    if(hits.length === 0){
      const pref = nice ? "P√≠o p√≠o üê§. " : "";
      return { ok:false, text: pref + "No encontr√© evidencia suficiente en la base para responder eso. Prueba con otras palabras clave (o revisa si ese tema est√° en la KB)." };
    }

    // Construye respuesta
    let out = "";
    if(nice) out += "Listo üê§. Encontr√© evidencia en la base:\n\n";

    if(!wantEvidence){
      // modo ‚Äús√≠ntesis‚Äù
      const ideas = [];
      for(const {b} of hits){
        const sent = pickSentences(b.text || "", words, 1)[0];
        if(sent) ideas.push("‚Ä¢ " + sent);
      }
      out += ideas.slice(0, mode === "brief" ? 3 : 5).join("\n");
      out += "\n\n";
      out += "Referencias:\n" + hits.map(({b}) => "‚Ä¢ " + formatSource(b)).join("\n");
      return { ok:true, text: out };
    }

    // modo ‚Äúcon evidencia‚Äù
    const maxSent = (mode === "brief") ? 1 : 2;

    hits.forEach(({b}, i) => {
      out += `${i+1}) ${formatSource(b)}\n`;
      const ss = pickSentences(b.text || "", words, maxSent);
      if(ss.length){
        ss.forEach(s => out += `   - ${s}\n`);
      } else if (b.text){
        out += `   - ${b.text.toString().slice(0, 260)}‚Ä¶\n`;
      } else {
        out += `   - (bloque sin texto)\n`;
      }
      out += "\n";
    });

    return { ok:true, text: out.trim() };
  }

  // ---- send ----
  function send(){
    const text = q.value.trim();
    if(!text) return;
    addMsg("user", text);
    q.value = "";
    const res = answerFromKB(text);
    addMsg("bot", res.text);
  }

  // ---- events ----
  btnSend.addEventListener("click", send);
  q.addEventListener("keydown", (e) => {
    if(e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      send();
    }
  });

  btnClear?.addEventListener("click", () => {
    greeting();
  });

  btnCopyLast?.addEventListener("click", async () => {
    const bubbles = [...document.querySelectorAll(".bubble.bot")];
    if(!bubbles.length) return;
    const last = bubbles[bubbles.length - 1].innerText.trim();
    try{
      await navigator.clipboard.writeText(last);
      // peque√±o feedback
      kbPill.animate([{transform:"scale(1)"},{transform:"scale(1.02)"},{transform:"scale(1)"}], {duration:220});
    }catch(e){}
  });

  // ---- init ----
  setChips(DEFAULT_CHIPS);
  greeting();
  loadKB();
})();
</script>
</body>
</html>






